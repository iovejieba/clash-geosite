name: Build Geosite Ultimate V1.0
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # 北京时间每天上午 08:00 自动运行
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout codebase
        uses: actions/checkout@v4

      - name: Set variables
        run: |
          # 1. 规则订阅列表
          echo "APPLE_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Apple/Apple.list" >> $GITHUB_ENV
          echo "APPLEAKAMAI_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/AppleAkamai.list" >> $GITHUB_ENV
          echo "GOOGLE_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google.list" >> $GITHUB_ENV
          echo "CN_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/CN.list" >> $GITHUB_ENV
          echo "DIRECT_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Direct.list" >> $GITHUB_ENV
          echo "GOOGLECN_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/GoogleDirect.list" >> $GITHUB_ENV
          echo "PROXY_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Proxy.list" >> $GITHUB_ENV
          echo "AI_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/AI.list" >> $GITHUB_ENV
          echo "BING_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Bing.list" >> $GITHUB_ENV
          echo "MS_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Microsoft/Microsoft.list" >> $GITHUB_ENV
          echo "MSCN_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/MicrosoftCN.list" >> $GITHUB_ENV
          echo "NETFLIX_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Netflix/Netflix.list" >> $GITHUB_ENV
          echo "TG_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Telegram/Telegram.list" >> $GITHUB_ENV
          echo "SOCIALMEDIA_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/SocialMedia.list" >> $GITHUB_ENV
          echo "HTTPDNS_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/HTTPDNS.list" >> $GITHUB_ENV
          echo "YOUTUBE_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/YouTube/YouTube.list" >> $GITHUB_ENV
          echo "ByteDance_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/ByteDance.list" >> $GITHUB_ENV
          echo "TIKTOK_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/TikTok/TikTok.list" >> $GITHUB_ENV
          echo "TRACKER_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Tracker.list" >> $GITHUB_ENV
          echo "Tencent_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Tencent.list" >> $GITHUB_ENV
          echo "JD_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/JD.list" >> $GITHUB_ENV
          echo "BILIBILI_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Bilibili.list" >> $GITHUB_ENV
          echo "GameCN_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/GameDirect.list" >> $GITHUB_ENV
          echo "Academic_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Academic.list" >> $GITHUB_ENV
          echo "GitHub_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/GitHub/GitHub.list" >> $GITHUB_ENV
          echo "ALIBABA_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Alibaba.list" >> $GITHUB_ENV
          echo "MT_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Meituan.list" >> $GITHUB_ENV
          echo "Reddit_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Reddit.list" >> $GITHUB_ENV
          echo "Spotify_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Spotify.list" >> $GITHUB_ENV
          echo "Meta_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Meta.list" >> $GITHUB_ENV
          echo "Twitter_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Twitter.list" >> $GITHUB_ENV
          echo "Cert_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Cert.list" >> $GITHUB_ENV
          echo "Talkatone_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Talkatone.list" >> $GITHUB_ENV
          echo "Claude_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Claude.list" >> $GITHUB_ENV
          echo "Twitch_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Twitch.list" >> $GITHUB_ENV
          echo "Disney_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Disney/Disney.list" >> $GITHUB_ENV
          echo "Huawei_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Huawei.list" >> $GITHUB_ENV
          echo "BD_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Baidu.list" >> $GITHUB_ENV
          echo "Wiki_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Wiki.list" >> $GITHUB_ENV
          echo "NetShare_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/NetShare.list" >> $GITHUB_ENV
          echo "Media_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Media.list" >> $GITHUB_ENV
          echo "UK_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/StreamingUK.list" >> $GITHUB_ENV
          echo "JP_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/StreamingJP.list" >> $GITHUB_ENV
          echo "MI_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/XiaoMi/XiaoMi.list" >> $GITHUB_ENV
          echo "Gemini_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Gemini.list" >> $GITHUB_ENV
          echo "Discord_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/Discord.list" >> $GITHUB_ENV
          echo "TW_URL=https://raw.githubusercontent.com/iovejieba/clash-geosite/master/rule-files/StreamingTW.list" >> $GITHUB_ENV
          echo "SSHOR3389_URL=https://raw.githubusercontent.com/iovejieba/clash/refs/heads/main/ssh.list" >> $GITHUB_ENV
          echo "GUAXIAO_URL=https://raw.githubusercontent.com/iovejieba/clash/refs/heads/main/guaxiao.list" >> $GITHUB_ENV
          echo "Crypto_URL=https://raw.githubusercontent.com/iovejieba/clash/refs/heads/main/Crypto.list" >> $GITHUB_ENV
          echo "EMBY_URL=https://raw.githubusercontent.com/iovejieba/clash/refs/heads/main/Emby.list" >> $GITHUB_ENV
          echo "PT_URL=https://raw.githubusercontent.com/iovejieba/clash/refs/heads/main/PrivateTracker.list" >> $GITHUB_ENV
          echo "Copilot_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Copilot/Copilot.list" >> $GITHUB_ENV
          echo "Bahamut_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Bahamut/Bahamut.list" >> $GITHUB_ENV
          echo "Cloudflare_URL=https://raw.githubusercontent.com/iovejieba/clash/refs/heads/main/Cloudflare.list" >> $GITHUB_ENV
          echo "GoogleFCM_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/GoogleFCM/GoogleFCM.list" >> $GITHUB_ENV
          echo "ProxyGFWlist_URL=https://raw.githubusercontent.com/iovejieba/clash/refs/heads/main/ProxyGFWlist.list" >> $GITHUB_ENV
          echo "DMM_URL=https://raw.githubusercontent.com/iovejieba/clash/refs/heads/main/DMM.list" >> $GITHUB_ENV
          echo "ChinaMedia_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaMedia/ChinaMedia.list" >> $GITHUB_ENV
          echo "GlobalMedia_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/GlobalMedia/GlobalMedia.list" >> $GITHUB_ENV
          echo "Steam_URL=https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Steam/Steam.list" >> $GITHUB_ENV
          echo "ChinaIp_URL=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ChinaIp.list" >> $GITHUB_ENV
          echo "ChinaDomain_URL=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ChinaDomain.list" >> $GITHUB_ENV
          echo "ChinaCompanyIp_URL=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ChinaCompanyIp.list" >> $GITHUB_ENV
          
          echo "RELEASE_NAME=Released on $(date +%Y%m%d%H%M)" >> $GITHUB_ENV

      - name: Checkout v2fly/domain-list-community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: community

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: false # 彻底解决 Restore cache failed 警告

      - name: Generate and Translate Rules
        run: |
          mkdir -p ./community/mydata
          #CLEAN_CMD="sed -E -n '/^DOMAIN(-SUFFIX|-KEYWORD|-FULL)?,/ { s/^DOMAIN-SUFFIX,//; s/^(DOMAIN|DOMAIN-FULL),/full:/; s/^DOMAIN-KEYWORD,/keyword:/; s/,.*//; p }'"
          CLEAN_CMD="awk -F, '{
            gsub(/[ \t\r]/, \"\", \$0); # 去空格和回车
            if (\$0 ~ /^#|^$/) next;    # 跳过注释和空行
            if (\$1 == \"DOMAIN-SUFFIX\") { print \$2 }
            else if (\$1 == \"DOMAIN\" || \$1 == \"DOMAIN-FULL\") { print \"full:\" \$2 }
            else if (\$1 == \"DOMAIN-KEYWORD\") { print \"keyword:\" \$2 }
            else if (NF == 1) { print \$1 } # 如果整行没逗号，当作普通域名处理
            else if (\$1 !~ /IP-CIDR|USER-AGENT|PROCESS-NAME/) { print \$1 } # 排除掉IP等无关规则，剩下的尝试保留
            }'"
          # 精确排除导致 403 的系统变量，确保不误伤 GitHub_URL
          for var in $(env | grep '_URL=' | grep -Ev "GITHUB_GRAPHQL_URL|GITHUB_API_URL" | cut -d= -f1); do
            url="${!var}"
            filename=$(echo "${var%_URL}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g')
            
            echo "Translating $filename from $url ..."
            curl -sSLf --retry 3 "$url" | eval "$CLEAN_CMD" | sed '/[^\x00-\x7F]/d; /^$/d' | sort -u > "./community/mydata/$filename"
            echo "File $filename generated with $(wc -l < ./community/mydata/$filename) lines."
          done

      - name: Build geosite.dat file
        run: |
          cd community || exit 1
          env -i PATH="$PATH" GOPATH="$(go env GOPATH)" GOCACHE="$(go env GOCACHE)" \
          go run ./ --datapath=./mydata --outputname geosite.dat

      - name: Build geosite.db file (Sing-box)
        run: |
          go install -trimpath -ldflags="-s -w" github.com/metacubex/geo/cmd/geo@master
          $(go env GOPATH)/bin/geo convert site -i v2ray -o sing -f geosite.db ./community/geosite.dat

      - name: Prepare Assets
        run: |
          mkdir -p ./publish
          cp -fp ./community/geosite.dat ./publish/geosite.dat
          cp -fp ./geosite.db ./publish/geosite.db
          cd ./publish
          sha256sum geosite.dat > geosite.dat.sha256sum
          sha256sum geosite.db > geosite.db.sha256sum

      - name: Release and upload assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: ${{ env.RELEASE_NAME }}
          tag: latest
          file_glob: true
          file: ./publish/*
          overwrite: true

      - name: Git push assets to "release" branch
        run: |
          cd publish || exit 1
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b release
          git add .
          git commit -m "${{ env.RELEASE_NAME }}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u origin release
